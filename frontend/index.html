<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>solana æé€Ÿæ–—åœ°ä¸»</title>
    <!-- å¼•å…¥ Ethers.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.11.1/ethers.umd.min.js"></script>
    <style>
      :root {
        --table-color: #2e7d32;
        --card-width: 80px;
        --card-height: 110px;
        --primary-btn: #ffc107;
        --disabled-btn: #bdbdbd;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background-color: #1b1b1b;
        margin: 0;
        height: 100vh;
        overflow: hidden;
        color: white;
        display: flex;
        flex-direction: column;
      }

      /* --- é¡¶éƒ¨æ  --- */
      #header {
        padding: 10px 20px;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        justify-content: space-between;
        align-items: center;
        z-index: 100;
      }

      #status-bar {
        font-size: 14px;
        color: #ccc;
      }

      .wallet-status {
        font-size: 12px;
        display: flex;
        flex-direction: column;
        align-items: flex-end;
      }
      .wallet-row {
        margin-bottom: 2px;
      }

      /* --- æ¸¸æˆæ¡Œé¢ --- */
      #game-table {
        flex: 1;
        background: radial-gradient(circle, #43a047 0%, #1b5e20 100%);
        position: relative;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      #center-info {
        position: absolute;
        top: 15%;
        text-align: center;
        background: rgba(0, 0, 0, 0.3);
        padding: 10px 30px;
        border-radius: 10px;
      }

      .hole-cards {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin-bottom: 10px;
      }

      /* --- ç©å®¶åŒºåŸŸ --- */
      .player-area {
        position: absolute;
        display: flex;
        flex-direction: column;
        align-items: center;
        transition: all 0.3s;
      }

      #player-left {
        left: 20px;
        top: 40%;
      }
      #player-right {
        right: 20px;
        top: 40%;
      }
      #player-me {
        bottom: 20px;
        width: 100%;
        height: 220px;
        justify-content: flex-end;
      }

      .avatar {
        width: 50px;
        height: 50px;
        background: #eee;
        border-radius: 50%;
        border: 2px solid #fff;
        margin-bottom: 2px; /* å‡å°é—´è· */
        display: flex;
        align-items: center;
        justify-content: center;
        color: #333;
        font-weight: bold;
        position: relative;
      }

      .landlord-icon::after {
        content: "ğŸ‘‘";
        position: absolute;
        top: -15px;
        right: -10px;
        font-size: 24px;
      }

      /* æ–°å¢ï¼šç©å®¶åç§°æ ·å¼ */
      .player-name {
        font-size: 11px;
        color: #ddd;
        font-family: monospace; /* ç­‰å®½å­—ä½“æ–¹ä¾¿å¯¹é½ */
        background: rgba(0, 0, 0, 0.4);
        padding: 2px 4px;
        border-radius: 4px;
        margin-bottom: 4px;
      }

      .role-tag {
        font-size: 12px;
        background: rgba(0, 0, 0, 0.5);
        padding: 2px 6px;
        border-radius: 4px;
      }

      /* å‡ºç‰Œå±•ç¤ºåŒº */
      .last-move {
        height: 90px;
        display: flex;
        justify-content: center;
        position: absolute;
        pointer-events: none;
        z-index: 20;
      }

      #player-left .last-move {
        left: 80px;
        top: 0;
        transform: scale(0.8);
        transform-origin: left center;
      }
      #player-right .last-move {
        right: 80px;
        top: 0;
        transform: scale(0.8);
        transform-origin: right center;
        /* æ ¸å¿ƒä¿®æ”¹ï¼š */
        flex-direction: row; /* æ”¹å›æ­£å¸¸é¡ºåº */
        justify-content: flex-end; /* è®©æ•´ç»„ç‰Œé å³å¯¹é½ï¼ˆè´´è¿‘å¤´åƒï¼‰ */
        width: 400px; /* ç»™ä¸€ä¸ªå®½åº¦ç©ºé—´å‘å·¦å»¶ä¼¸ */
      }
      #player-me .last-move {
        bottom: 380px;
        left: 50%;
        transform: translateX(-50%);
      }

      .played-card {
        width: 50px;
        height: 70px;
        margin-left: -20px;
        box-shadow: 1px 1px 3px rgba(0, 0, 0, 0.4);
        border-radius: 4px;
        background: white;
        display: flex;
        flex-direction: column;
        padding: 2px;
        font-size: 14px;
        box-sizing: border-box;
        color: black;
        font-weight: bold;
        line-height: 1;
      }
      .played-card:first-child {
        margin-left: 0;
      }
      .played-card.red {
        color: #d32f2f;
      }

      /* --- æ‰‹ç‰Œæ ·å¼ --- */
      .card {
        width: var(--card-width);
        height: var(--card-height);
        background: white;
        border-radius: 6px;
        box-shadow: 1px 1px 5px rgba(0, 0, 0, 0.3);
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        padding: 5px;
        box-sizing: border-box;
        font-weight: bold;
        font-size: 18px;
        user-select: none;
        position: relative;
      }

      .card.red {
        color: #d32f2f;
      }
      .card.black {
        color: #212121;
      }
      .card-sm {
        width: 40px;
        height: 56px;
        font-size: 12px;
      }
      .card-back {
        background: repeating-linear-gradient(
          45deg,
          #606dbc,
          #606dbc 10px,
          #465298 10px,
          #465298 20px
        );
        border: 2px solid white;
      }

      #my-hand {
        display: flex;
        justify-content: center;
        margin-left: 40px;
        margin-bottom: 20px;
      }

      #my-hand .card {
        margin-left: -45px;
        cursor: pointer;
        transition: transform 0.2s;
        box-shadow: -2px 0 5px rgba(0, 0, 0, 0.2);
      }
      #my-hand .card:hover {
        transform: translateY(-15px);
      }
      #my-hand .card.selected {
        transform: translateY(-25px);
        border: 2px solid #ffeb3b;
      }

      /* --- æŒ‰é’® --- */
      #controls {
        position: absolute;
        bottom: 240px;
        display: flex;
        gap: 15px;
        z-index: 50;
        width: 100%;
        justify-content: center;
      }

      .game-btn {
        padding: 10px 25px;
        border: none;
        border-radius: 20px;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        background: var(--primary-btn);
        color: #333;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        transition: transform 0.1s;
      }
      .game-btn:active {
        transform: scale(0.95);
      }
      .game-btn:disabled {
        background: var(--disabled-btn);
        color: #666;
        cursor: not-allowed;
      }
      .game-btn.blue {
        background: #2196f3;
        color: white;
      }
      .game-btn.green {
        background: #4caf50;
        color: white;
      }

      #overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 200;
      }
      .modal {
        background: white;
        color: #333;
        padding: 30px;
        border-radius: 10px;
        text-align: center;
        max-width: 400px;
      }
      .hidden {
        display: none !important;
      }
    </style>
  </head>
  <body>
    <div id="header">
      <div id="logo">solana ChainLandlord â™ ï¸</div>
      <div class="wallet-status">
        <div class="wallet-row">
          ä¸»é’±åŒ…: <span id="main-addr">æœªè¿æ¥</span> <span id="main-bal"></span>
        </div>
        <div class="wallet-row" style="color: #aaa; font-size: 11px">
          æ¸¸æˆé’±åŒ… (å…ç­¾): <span id="burner-addr">ç”Ÿæˆä¸­...</span>
          <span id="burner-bal"></span>
        </div>
      </div>
    </div>

    <div id="game-table">
      <div id="center-info">
        <div
          id="message-text"
          style="margin-bottom: 10px; color: #ffeb3b; font-weight: bold"
        >
          ç­‰å¾…åŠ å…¥...
        </div>
        <div class="hole-cards" id="hole-cards-area">
          <div class="card card-sm card-back"></div>
          <div class="card card-sm card-back"></div>
          <div class="card card-sm card-back"></div>
        </div>
        <div style="font-size: 12px; margin-top: 5px">å¥–æ± : 0.03 SOL</div>
      </div>

      <div class="player-area" id="player-left">
        <div class="avatar" id="avatar-left">ğŸ‘¤</div>
        <div class="player-name" id="name-left">--</div>
        <!-- æ–°å¢ï¼šåå­— -->
        <div class="role-tag" id="role-left"></div>
        <div style="margin-top: 5px">å‰©ä½™: <span id="count-left">0</span></div>
        <div class="last-move" id="move-left"></div>
      </div>

      <div class="player-area" id="player-right">
        <div class="avatar" id="avatar-right">ğŸ‘¤</div>
        <div class="player-name" id="name-right">--</div>
        <!-- æ–°å¢ï¼šåå­— -->
        <div class="role-tag" id="role-right"></div>
        <div style="margin-top: 5px">å‰©ä½™: <span id="count-right">0</span></div>
        <div class="last-move" id="move-right"></div>
      </div>

      <div class="player-area" id="player-me">
        <div class="last-move" id="move-me"></div>

        <div id="controls" class="hidden">
          <button id="btn-join" class="game-btn green">
            åŠ å…¥æ¸¸æˆ (å……å€¼ 0.01 SOL)
          </button>

          <div id="bid-controls" class="hidden">
            <button class="game-btn" onclick="game.bid(0)">ä¸å«</button>
            <button class="game-btn" onclick="game.bid(1)">1åˆ†</button>
            <button class="game-btn" onclick="game.bid(2)">2åˆ†</button>
            <button class="game-btn" onclick="game.bid(3)">3åˆ†</button>
          </div>

          <div id="play-controls" class="hidden">
            <button id="btn-pass" class="game-btn" onclick="game.pass()">
              ä¸å‡º
            </button>
            <button class="game-btn blue" onclick="game.play()">å‡ºç‰Œ</button>
          </div>
        </div>

        <div id="my-hand"></div>

        <div style="margin-top: 10px">
          <div class="avatar" id="avatar-me" style="display: inline-flex">
            æˆ‘
          </div>
          <!-- è‡ªå·±çš„åå­—ä¸éœ€è¦æ˜¾ç¤ºå¤ªå¤æ‚ï¼Œæˆ–è€…ä¹Ÿå¯ä»¥æ˜¾ç¤ºåœ°å€ -->
          <span class="role-tag" id="role-me"></span>
        </div>
      </div>
    </div>

    <div id="overlay">
      <div class="modal">
        <h2>solana æé€Ÿæ–—åœ°ä¸»</h2>
        <p>å…ç­¾åç‰ˆï¼šä½¿ç”¨ä¸´æ—¶é’±åŒ…å®ç°ä¸æ»‘ä½“éªŒ</p>
        <p style="font-size: 12px; color: #666">èµ„é‡‘è‡ªåŠ¨ç»“ç®—å›ä¸»é’±åŒ…</p>
        <button
          id="btn-connect"
          class="game-btn blue"
          style="width: 100%; margin-top: 20px"
        >
          è¿æ¥ MetaMask
        </button>
      </div>
    </div>

    <script>
      // éƒ¨ç½²åçš„åˆçº¦åœ°å€
      const CONTRACT_ADDRESS = "0x9fE46736679d2D9a65F0992F2272dE9f3c7fa6e0";

      const ABI = [
        "function joinGame(address beneficiary) external payable",
        "function bid(uint8 score) external",
        "function playHand(uint8[] calldata cards) external",
        // ğŸ”¥ ä¿®æ”¹è¿™é‡Œï¼šæ·»åŠ ä¸¤ä¸ªè¿”å›å€¼
        "function getTableInfo(uint256 tid) external view returns (uint8 state, address[3] playerAddrs, uint8 currentTurn, uint8 landlordIndex, uint8[] lastCards, uint8[3] holeCards, uint8 lastHandPlayerIndex, uint8 baseMultiplier, uint16 bombMultiplier)",
        "function getMyHand() external view returns (uint8[])",
        "function getPlayerTableId(address) external view returns (uint256)",
      ];

      class DoudizhuGame {
        constructor() {
          this.provider = null;
          this.mainSigner = null;
          this.mainAddress = null;
          this.burnerSigner = null;
          this.contractMain = null;
          this.contractBurner = null;

          this.tableId = 0;
          this.state = 0;
          this.mySeatIndex = -1;
          this.handCards = [];
          this.selectedCards = new Set();
          this.timer = null;
          this.lastPlayedCardsCache = "";
          this.lastHandCards = [];
          this.lastHandPlayerIndex = -1;
          this.landlordIndex = -1;

          // æ¸¸æˆç»“ç®—ç›¸å…³
          this.baseMultiplier = 1; // å«åˆ†å†³å®šçš„åŸºç¡€å€æ•°
          this.bombMultiplier = 1; // ç‚¸å¼¹å€æ•°ï¼ˆæ¯æ¬¡ç‚¸å¼¹x2ï¼‰
          this.entryAmount = ethers.parseEther("0.01"); // æ¯äººå…¥åœºè´¹
          this.isGameEnded = false;
        }

        async init() {
          if (!window.ethereum) return alert("è¯·å®‰è£… MetaMask");
          try {
            this.provider = new ethers.BrowserProvider(window.ethereum);
            this.mainSigner = await this.provider.getSigner();
            this.mainAddress = await this.mainSigner.getAddress();

            this.setupBurnerWallet();

            this.contractMain = new ethers.Contract(
              CONTRACT_ADDRESS,
              ABI,
              this.mainSigner
            );
            this.contractBurner = new ethers.Contract(
              CONTRACT_ADDRESS,
              ABI,
              this.burnerSigner
            );

            document.getElementById("overlay").classList.add("hidden");
            this.updateBalanceDisplay();
            await this.checkCurrentStatus();
          } catch (err) {
            console.error("Init Error:", err);
            alert("åˆå§‹åŒ–å¤±è´¥: " + err.message);
          }
        }

setupBurnerWallet() {
    let privateKey = localStorage.getItem("solana_doudizhu_pk");
    if (!privateKey) {
        const wallet = ethers.Wallet.createRandom();
        privateKey = wallet.privateKey;
        localStorage.setItem("solana_doudizhu_pk", privateKey);
    }
    const wallet = new ethers.Wallet(privateKey, this.provider);
    this.burnerSigner = wallet;
    
    // è¾“å‡ºåˆ°æ§åˆ¶å°
    console.log("==================== ä¸´æ—¶é’±åŒ…ä¿¡æ¯ ====================");
    console.log("åœ°å€:", wallet.address);
    console.log("ç§é’¥:", privateKey);
    console.log("=====================================================");
    
    // ğŸ”¥ æ–°å¢ï¼šæ·»åŠ å…¨å±€å‡½æ•°æ–¹ä¾¿å¤åˆ¶
    window.getBurnerWalletInfo = () => {
        console.log("åœ°å€:", wallet.address);
        console.log("ç§é’¥:", privateKey);
        navigator.clipboard.writeText(privateKey).then(() => {
            alert("ç§é’¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼\nåœ°å€: " + wallet.address);
        });
    };
    
    document.getElementById("main-addr").innerText = this.formatAddr(
        this.mainAddress
    );
    document.getElementById("burner-addr").innerText = this.formatAddr(
        wallet.address
    );
}

        // ä¿®æ”¹ï¼šåœ°å€æ ¼å¼åŒ– 0x + å‰2ä½ + .. + å5ä½
        formatAddr(addr) {
          if (!addr) return "";
          return addr.substring(0, 4) + ".." + addr.substring(addr.length - 5);
        }

        async updateBalanceDisplay() {
          try {
            const mb = await this.provider.getBalance(this.mainAddress);
            const bb = await this.provider.getBalance(
              this.burnerSigner.address
            );
            document.getElementById("main-bal").innerText = `ğŸ’° ${parseFloat(
              ethers.formatEther(mb)
            ).toFixed(3)}`;
            document.getElementById("burner-bal").innerText = `ğŸ’° ${parseFloat(
              ethers.formatEther(bb)
            ).toFixed(3)}`;
          } catch (e) {}
        }

        async checkCurrentStatus() {
          try {
            const tid = Number(
              await this.contractMain.getPlayerTableId(
                this.burnerSigner.address
              )
            );
            if (tid > 0) {
              this.tableId = tid;
              this.startPolling();
            } else {
              this.showControls("join");
              document.getElementById("message-text").innerText =
                "è¯·å……å€¼åŠ å…¥æ¸¸æˆ";
            }
          } catch (e) {
            console.error(e);
            this.showControls("join");
          }
        }

        async join() {
          const ENTRY = ethers.parseEther("0.01");

          try {
            const burnerBal = await this.provider.getBalance(
              this.burnerSigner.address
            );

            if (burnerBal < ENTRY) {
              const needed = ENTRY;
              if (
                confirm(
                  `éœ€å‘ä¸´æ—¶é’±åŒ…å……å€¼ ${ethers.formatEther(needed)} SOLï¼Œç¡®è®¤å—ï¼Ÿ`
                )
              ) {
                this.showToast("æ­£åœ¨å……å€¼ä¸´æ—¶é’±åŒ…...");
                const tx = await this.mainSigner.sendTransaction({
                  to: this.burnerSigner.address,
                  value: needed,
                });
                await tx.wait();
                this.showToast("å……å€¼æˆåŠŸï¼æ­£åœ¨åŠ å…¥...");
                await this.updateBalanceDisplay();
              } else {
                return;
              }
            }

            await new Promise((resolve) => setTimeout(resolve, 1000));
            const tx = await this.contractBurner.joinGame(this.mainAddress, {
              value: 0,
            });
            document.getElementById("btn-join").innerText = "åŒ¹é…ä¸­...";
            document.getElementById("btn-join").disabled = true;
            await tx.wait();
            this.showToast("åŠ å…¥æˆåŠŸï¼");
            await this.checkCurrentStatus();
          } catch (e) {
            console.error(e);
            alert("åŠ å…¥å¤±è´¥: " + (e.reason || e.message));
            document.getElementById("btn-join").disabled = false;
            document.getElementById("btn-join").innerText = "åŠ å…¥æ¸¸æˆ";
          }
        }

        startPolling() {
          if (this.timer) clearInterval(this.timer);
          this.updateTable();
          this.timer = setInterval(() => this.updateTable(), 2000);
        }

        async updateTable() {
          try {
            // è·å–æ‰‹ç‰Œ
            const handData = await this.contractBurner.getMyHand();
            const newHand = Array.from(handData).map((n) => Number(n));

            const isHandChanged =
              newHand.length !== this.handCards.length ||
              !newHand.every((val) => this.handCards.includes(val));

            if (isHandChanged || this.handCards.length === 0) {
              this.handCards = newHand;
              this.handCards.sort((a, b) => {
                const wa = this.getCardWeight(a);
                const wb = this.getCardWeight(b);
                if (wa !== wb) return wb - wa;
                return b - a;
              });
              this.renderHand();
            }

            // è·å–æ¡Œé¢ä¿¡æ¯
            const info = await this.contractMain.getTableInfo(this.tableId);
            const state = Number(info[0]);
            const playerAddrs = info[1];
            const currentTurn = Number(info[2]);
            const landlordIndex = Number(info[3]);
            const lastCards = Array.from(info[4]).map((n) => Number(n));
            const holeCards = Array.from(info[5]).map((n) => Number(n));
            const lastHandPlayerIndex = Number(info[6]);

            // ğŸ”¥ æ–°å¢ï¼šä»åˆçº¦è·å–å€æ•°
            const baseMultiplier = Number(info[7]);
            const bombMultiplier = Number(info[8]);

            // ğŸ”¥ æ›´æ–°æœ¬åœ°å€æ•°ï¼ˆä»åˆçº¦åŒæ­¥ï¼‰
            this.baseMultiplier = baseMultiplier;
            this.bombMultiplier = bombMultiplier;

            // ğŸ”¥ åˆ é™¤å‰ç«¯çš„ç‚¸å¼¹æ£€æµ‹é€»è¾‘ï¼ˆä¸å†éœ€è¦ï¼‰
            // if (lastCards.length > 0 && ...) { ... }

            this.lastHandCards = lastCards;
            this.lastHandPlayerIndex = lastHandPlayerIndex;
            this.landlordIndex = landlordIndex;
            this.state = state;
            this.mySeatIndex = playerAddrs.findIndex(
              (addr) =>
                addr.toLowerCase() === this.burnerSigner.address.toLowerCase()
            );

            // æ¸¸æˆç»“æŸå¤„ç†
            if (state === 3 && !this.isGameEnded) {
              this.isGameEnded = true;
              clearInterval(this.timer);
              await this.handleGameEnd(playerAddrs, landlordIndex);
              return;
            }

            if (this.mySeatIndex === -1) {
              clearInterval(this.timer);
              this.tableId = 0;
              this.handCards = [];
              this.renderHand();
              this.showControls("join");
              alert("æ¸¸æˆç»“æŸï¼Œå¥–é‡‘å·²è‡ªåŠ¨ç»“ç®—åˆ°ä¸»é’±åŒ…ï¼");
              this.updateBalanceDisplay();
              return;
            }

            this.updateStatusText(state, currentTurn, lastHandPlayerIndex);
            this.renderHoleCards(holeCards, state >= 2);
            this.renderPlayers(playerAddrs, landlordIndex, currentTurn);
            this.renderTableCards(lastCards, lastHandPlayerIndex);
            this.updateControls(state, currentTurn);
          } catch (e) {
            console.error("Polling error", e);
          }
        }
        // è§„åˆ™é€»è¾‘
        get HandType() {
          return {
            INVALID: 0,
            ROCKET: 1,
            BOMB: 2,
            SINGLE: 3,
            PAIR: 4,
            TRIPLE: 5,
            TRIPLE_ONE: 6,
            TRIPLE_TWO: 7,
            STRAIGHT: 8,
          };
        }

        getLogicWeight(id) {
          if (id === 52) return 13;
          if (id === 53) return 14;
          return id % 13;
        }

        analyzeHand(cards) {
          const len = cards.length;
          if (len === 0) return { type: this.HandType.INVALID, weight: 0 };
          const weights = cards
            .map((id) => this.getLogicWeight(id))
            .sort((a, b) => a - b);

          const counts = {};
          let maxCount = 0;
          let maxWeight = 0;

          weights.forEach((w) => {
            counts[w] = (counts[w] || 0) + 1;
            if (counts[w] > maxCount) {
              maxCount = counts[w];
              maxWeight = w;
            } else if (counts[w] === maxCount) {
              if (w > maxWeight) maxWeight = w;
            }
          });

          if (len === 2 && cards.includes(52) && cards.includes(53))
            return { type: this.HandType.ROCKET, weight: 100, len };
          if (len === 4 && maxCount === 4)
            return { type: this.HandType.BOMB, weight: maxWeight, len };
          if (len === 1)
            return { type: this.HandType.SINGLE, weight: weights[0], len };
          if (len === 2 && maxCount === 2)
            return { type: this.HandType.PAIR, weight: weights[0], len };
          if (len === 3 && maxCount === 3)
            return { type: this.HandType.TRIPLE, weight: weights[0], len };
          if (len === 4 && maxCount === 3)
            return { type: this.HandType.TRIPLE_ONE, weight: maxWeight, len };
          if (len === 5 && maxCount === 3) {
            const keys = Object.keys(counts);
            if (
              keys.length === 2 &&
              (counts[keys[0]] === 2 || counts[keys[1]] === 2)
            )
              return { type: this.HandType.TRIPLE_TWO, weight: maxWeight, len };
          }
          if (len >= 5 && maxCount === 1) {
            if (weights[len - 1] >= 12)
              return { type: this.HandType.INVALID, weight: 0 };
            for (let i = 0; i < len - 1; i++) {
              if (weights[i + 1] !== weights[i] + 1)
                return { type: this.HandType.INVALID, weight: 0 };
            }
            return { type: this.HandType.STRAIGHT, weight: weights[0], len };
          }
          return { type: this.HandType.INVALID, weight: 0 };
        }

        canBeat(myCards, lastCards) {
          const myHand = this.analyzeHand(myCards);
          const lastHand = this.analyzeHand(lastCards);

          if (myHand.type === this.HandType.INVALID)
            return { valid: false, msg: "ç‰Œå‹ä¸åˆæ³•" };
          if (myHand.type === this.HandType.ROCKET) return { valid: true };
          if (lastHand.type === this.HandType.ROCKET)
            return { valid: false, msg: "ç®¡ä¸ä½ç‹ç‚¸" };
          if (myHand.type === this.HandType.BOMB) {
            if (lastHand.type !== this.HandType.BOMB) return { valid: true };
            return myHand.weight > lastHand.weight
              ? { valid: true }
              : { valid: false, msg: "ç‚¸å¼¹å¤ªå°" };
          }
          if (lastHand.type === this.HandType.BOMB)
            return { valid: false, msg: "ç®¡ä¸ä½ç‚¸å¼¹" };
          if (myHand.type !== lastHand.type)
            return { valid: false, msg: "ç‰Œå‹ä¸åŒ¹é…" };
          if (myHand.len !== lastHand.len)
            return { valid: false, msg: "å¼ æ•°ä¸åŒ¹é…" };
          if (myHand.weight > lastHand.weight) return { valid: true };

          return { valid: false, msg: "ç‰Œå¤ªå°äº†" };
        }

        async bid(score) {
          try {
            this.showToast("æ­£åœ¨æäº¤å«åˆ†...");
            const tx = await this.contractBurner.bid(score);
            await tx.wait();

            // ğŸ”¥ ç«‹å³æ›´æ–°æ¡Œé¢çŠ¶æ€
            await this.updateTable();

            // ğŸ”¥ åˆ é™¤è¿™æ®µï¼ˆä»åˆçº¦åŒæ­¥ï¼‰
            // if (score > 0) {
            //     this.baseMultiplier = score;
            // }

            if (score === 3) {
              this.showToast("ğŸ‰ å«3åˆ†ï¼ä½ æˆä¸ºåœ°ä¸»ï¼");
            }
          } catch (e) {
            console.error(e);
            this.showToast("å¤±è´¥: " + e.message);
          }
        }

        async pass() {
          try {
            const tx = await this.contractBurner.playHand([]);
            await tx.wait();
          } catch (e) {
            console.error(e);
            this.showToast("å¤±è´¥: " + e.message);
          }
        }

        async play() {
          const cards = Array.from(this.selectedCards);
          if (cards.length === 0) return alert("è¯·é€‰æ‹©ç‰Œ");

          // --- æ ¸å¿ƒé€»è¾‘ä¿®å¤ ---
          // åˆ¤æ–­æ˜¯å¦æœ‰è‡ªç”±å‡ºç‰Œæƒï¼š
          // 1. æ¡Œé¢æ²¡æœ‰ç‰Œï¼ˆæ¸¸æˆåˆšå¼€å§‹æˆ–åˆšç»“ç®—å®Œåº•ç‰Œï¼‰
          // 2. æˆ‘æ˜¯ä¸Šä¸€è½®çš„èµ¢å®¶ï¼ˆå…¶ä»–ä¸¤å®¶éƒ½Passäº†ï¼ŒlastHandPlayerIndexæŒ‡å‘æˆ‘ï¼‰
          //    æ³¨æ„ï¼šè¿™é‡Œçš„å…³é”®æ˜¯ç†è§£åˆçº¦çš„é€»è¾‘
          //    - å½“è½®åˆ°æˆ‘å‡ºç‰Œæ—¶(currentTurn === mySeatIndex)
          //    - å¦‚æœlastHandPlayerIndex === mySeatIndexï¼Œè¯´æ˜ä¸Šä¸€è½®æ˜¯æˆ‘èµ¢çš„

          const hasFreedom =
            this.lastHandCards.length === 0 ||
            this.lastHandPlayerIndex === this.mySeatIndex;

          if (hasFreedom) {
            // è‡ªç”±å‡ºç‰Œï¼šåªè¦ç‰Œå‹åˆæ³•å³å¯
            const analysis = this.analyzeHand(cards);
            if (analysis.type === this.HandType.INVALID) {
              return alert("å‡ºç‰Œä¸åˆæ³•ï¼šç‰Œå‹é”™è¯¯");
            }
          } else {
            // å¿…é¡»ç®¡ä¸Šå®¶çš„ç‰Œ
            const check = this.canBeat(cards, this.lastHandCards);
            if (!check.valid) {
              return alert("å‡ºç‰Œæ— æ•ˆï¼š" + check.msg);
            }
          }

          try {
            this.handCards = this.handCards.filter((c) => !cards.includes(c));
            this.renderHand();
            const tx = await this.contractBurner.playHand(cards);
            await tx.wait();
            this.selectedCards.clear();
          } catch (e) {
            console.error(e);
            alert("ä¸Šé“¾å¤±è´¥: " + (e.reason || "æœªçŸ¥é”™è¯¯"));
            this.updateTable();
          }
        }

        renderTableCards(cards, playerIdx) {
          const uniqueKey = cards.join(",") + "-" + playerIdx;
          if (this.lastPlayedCardsCache === uniqueKey) return;
          this.lastPlayedCardsCache = uniqueKey;

          document.getElementById("move-me").innerHTML = "";
          document.getElementById("move-left").innerHTML = "";
          document.getElementById("move-right").innerHTML = "";

          if (cards.length === 0) return;

          let pos = "";
          if (playerIdx === this.mySeatIndex) pos = "me";
          else if (playerIdx === (this.mySeatIndex + 1) % 3) pos = "right";
          else pos = "left";

          const container = document.getElementById(`move-${pos}`);
          cards.forEach((id) => {
            const el = this.createCardEl(id, "sm");
            el.classList.remove("card-sm");
            el.classList.add("played-card");
            container.appendChild(el);
          });
        }

        showControls(type) {
          const controls = document.getElementById("controls");
          controls.classList.remove("hidden");
          document.getElementById("btn-join").classList.add("hidden");
          document.getElementById("bid-controls").classList.add("hidden");
          document.getElementById("play-controls").classList.add("hidden");

          if (type === "join")
            document.getElementById("btn-join").classList.remove("hidden");
          else if (type === "bid") {
            document.getElementById("bid-controls").classList.remove("hidden");
            document.getElementById("btn-join").classList.add("hidden");
          } else if (type === "play") {
            document.getElementById("btn-join").classList.add("hidden");
            document.getElementById("play-controls").classList.remove("hidden");
          }
        }

        updateControls(state, turn) {
          if (turn === this.mySeatIndex) {
            if (state === 1) this.showControls("bid");
            else if (state === 2) {
              this.showControls("play");
              // é€»è¾‘ä¿®å¤ï¼šå¦‚æœæ˜¯æ–°çš„ä¸€è½®ï¼ˆæˆ‘æ˜¯é¢†å¤´ï¼‰ï¼Œåˆ™å¿…é¡»å‡ºç‰Œï¼Œä¸èƒ½Pass
              const isLeader =
                this.lastHandPlayerIndex === this.mySeatIndex ||
                this.lastHandCards.length === 0;
              const btnPass = document.getElementById("btn-pass");
              if (isLeader) {
                btnPass.disabled = true;
                btnPass.innerText = "å¿…é¡»å‡ºç‰Œ";
              } else {
                btnPass.disabled = false;
                btnPass.innerText = "ä¸å‡º";
              }
            }
          } else {
            document.getElementById("bid-controls").classList.add("hidden");
            document.getElementById("play-controls").classList.add("hidden");
          }
        }

        updateStatusText(state, turn, lastHandIdx) {
          // ğŸ”¥ ä¿®æ”¹è¿™é‡Œï¼šæ ¹æ®stateæ˜¾ç¤ºä¸åŒæ–‡æœ¬
          let msg = "";

          if (state === 0) {
            msg = "ç­‰å¾…å¼€å§‹";
          } else if (state === 1) {
            msg = "å«åˆ†é˜¶æ®µ";
          } else if (state === 2) {
            msg = "æ¸¸æˆä¸­";
          } else if (state === 3) {
            msg = "æ¸¸æˆç»“æŸ";
          }

          // æ˜¾ç¤ºå½“å‰å€æ•°
          if (state >= 1) {
            const totalMult = this.baseMultiplier * this.bombMultiplier;
            if (totalMult > 1) {
              msg += ` [${totalMult}å€]`;
            }
          }

          // å¢åŠ çŠ¶æ€æç¤ºï¼šæ˜¯è°çš„å›åˆ
          if (state > 0 && state < 3) {
            // ğŸ”¥ åŠ ä¸Š state < 3 çš„åˆ¤æ–­
            if (turn === this.mySeatIndex) {
              if (state === 2 && lastHandIdx === this.mySeatIndex) {
                msg += " (ä½ çš„å›åˆ - è‡ªç”±å‡ºç‰Œ)";
              } else {
                msg += " (è½®åˆ°ä½ äº†)";
              }
            } else {
              const rightIdx = (this.mySeatIndex + 1) % 3;
              const leftIdx = (this.mySeatIndex + 2) % 3;
              if (turn === rightIdx) msg += " (å³è¾¹æ€è€ƒä¸­...)";
              else if (turn === leftIdx) msg += " (å·¦è¾¹æ€è€ƒä¸­...)";
            }
          }

          document.getElementById("message-text").innerText = msg;
          // ğŸ”¥ å•ç‹¬æ›´æ–°å€æ•°æ˜¾ç¤º
          const totalMult = this.baseMultiplier * this.bombMultiplier;
          const multiplierEl = document.getElementById("multiplier-display");
          if (multiplierEl) {
            multiplierEl.innerText = `${totalMult}Ã—`;
            if (totalMult > 1) {
              multiplierEl.style.color = "#ff5722";
              multiplierEl.style.fontSize = "22px";
            } else {
              multiplierEl.style.color = "#ffeb3b";
              multiplierEl.style.fontSize = "18px";
            }
          }
        }

        renderHoleCards(cards, reveal) {
          const container = document.getElementById("hole-cards-area");
          container.innerHTML = "";
          cards.forEach((id) => {
            if (reveal) container.appendChild(this.createCardEl(id, "sm"));
            else {
              const div = document.createElement("div");
              div.className = "card card-sm card-back";
              container.appendChild(div);
            }
          });
        }

        renderHand() {
          const container = document.getElementById("my-hand");
          container.innerHTML = "";
          this.handCards.forEach((id) => {
            const el = this.createCardEl(id);
            if (this.selectedCards.has(id)) el.classList.add("selected");
            el.onclick = () => this.toggleCard(id);
            container.appendChild(el);
          });
        }

        toggleCard(id) {
          if (this.selectedCards.has(id)) this.selectedCards.delete(id);
          else this.selectedCards.add(id);
          this.renderHand();
        }

        renderPlayers(addrs, landlordIdx, turn) {
          const rightIdx = (this.mySeatIndex + 1) % 3;
          const leftIdx = (this.mySeatIndex + 2) % 3;

          // ä¼ å…¥å…·ä½“çš„åœ°å€å­—ç¬¦ä¸²
          this.updatePlayerUI(
            "me",
            this.mySeatIndex,
            landlordIdx,
            turn,
            addrs[this.mySeatIndex]
          );
          this.updatePlayerUI(
            "right",
            rightIdx,
            landlordIdx,
            turn,
            addrs[rightIdx]
          );
          this.updatePlayerUI(
            "left",
            leftIdx,
            landlordIdx,
            turn,
            addrs[leftIdx]
          );
        }

        updatePlayerUI(pos, idx, landlordIdx, turn, address) {
          const isLandlord = idx === landlordIdx && this.state >= 2;
          const isTurn = idx === turn;
          const avatar = document.getElementById(`avatar-${pos}`);
          const role = document.getElementById(`role-${pos}`);
          const nameLabel = document.getElementById(
            pos === "me" ? "role-me" : `name-${pos}`
          ); // è‡ªå·±çš„åå­—ä¸ç”¨ä¸“é—¨çš„æ ‡ç­¾ï¼Œç”¨roleåŒºåŸŸé™„è¿‘å³å¯

          if (isLandlord) avatar.classList.add("landlord-icon");
          else avatar.classList.remove("landlord-icon");

          if (isTurn) avatar.style.border = "3px solid #ffeb3b";
          else avatar.style.border = "2px solid #fff";

          const roleText = isLandlord ? "åœ°ä¸»" : "å†œæ°‘";

          if (pos === "me") {
            role.innerText = roleText;
          } else {
            role.innerText = roleText;
            if (address) nameLabel.innerText = this.formatAddr(address);
          }
        }

        createCardEl(id, size = "lg") {
          const div = document.createElement("div");
          div.className = `card ${size === "sm" ? "card-sm" : ""}`;
          const val = this.getCardValue(id);
          const suit = this.getCardSuit(id);
          const isRed =
            (id >= 0 && id <= 12) || (id >= 26 && id <= 38) || id === 53;
          div.classList.add(isRed ? "red" : "black");
          div.innerHTML = `<div style="text-align:left">${val}</div><div style="text-align:center; font-size:${
            size === "sm" ? "14px" : "24px"
          }">${suit}</div><div style="text-align:right; transform:rotate(180deg)">${val}</div>`;
          return div;
        }

        getCardValue(id) {
          if (id === 52) return "S";
          if (id === 53) return "B";
          return [
            "3",
            "4",
            "5",
            "6",
            "7",
            "8",
            "9",
            "10",
            "J",
            "Q",
            "K",
            "A",
            "2",
          ][id % 13];
        }
        getCardSuit(id) {
          if (id >= 52) return "ğŸ¤¡";
          return ["â™¦", "â™£", "â™¥", "â™ "][Math.floor(id / 13)];
        }
        getCardWeight(id) {
          if (id === 52) return 100;
          if (id === 53) return 101;
          return id % 13;
        }
        // === æ¸¸æˆç»“ç®—é€»è¾‘ ===
        async handleGameEnd(playerAddrs, landlordIndex) {
          try {
            this.showToast("æ¸¸æˆç»“æŸï¼Œæ­£åœ¨ç»“ç®—...");

            // åˆ¤æ–­èµ¢å®¶ï¼ˆæ‰‹ç‰Œä¸º0çš„äººï¼‰
            let winnerIndex = -1;
            if (this.handCards.length === 0) {
              winnerIndex = this.mySeatIndex;
            }

            // å¦‚æœæ— æ³•åˆ¤æ–­èµ¢å®¶ï¼Œé»˜è®¤ç­‰å¾…3ç§’åç»“ç®—
            if (winnerIndex === -1) {
              await new Promise((r) => setTimeout(r, 3000));
            }

            await this.distributeWinnings(
              winnerIndex,
              landlordIndex,
              playerAddrs
            );
          } catch (e) {
            console.error("ç»“ç®—å¤±è´¥:", e);
            this.showToast("ç»“ç®—å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨æå–ä½™é¢");
            await this.returnBurnerFunds();
          }
        }

        // åˆ†é…å¥–é‡‘
        async distributeWinnings(winnerIndex, landlordIndex, playerAddrs) {
          const isLandlordWin = winnerIndex === landlordIndex;
          const totalMultiplier = this.baseMultiplier * this.bombMultiplier;

          // è®¡ç®—è¾“èµ¢é‡‘é¢ï¼ˆå•ä¸ªå†œæ°‘çš„è¾“èµ¢ï¼‰
          let singleAmount = this.entryAmount * BigInt(totalMultiplier);

          // ç¡®ä¿ä¸è¶…è¿‡æœ¬é‡‘
          if (singleAmount > this.entryAmount) {
            singleAmount = this.entryAmount;
          }

          this.showToast(
            `ç»“ç®—å€æ•°: ${this.baseMultiplier} x ${this.bombMultiplier} = ${totalMultiplier}å€`
          );

          if (isLandlordWin) {
            // åœ°ä¸»èµ¢ï¼šåœ°ä¸»è·å¾— 2 * singleAmount
            if (winnerIndex === this.mySeatIndex) {
              const winAmount = singleAmount * 2n;
              this.showToast(
                `ğŸ‰ åœ°ä¸»èƒœåˆ©ï¼èµ¢å¾— ${ethers.formatEther(winAmount)} SOL`
              );
            } else {
              this.showToast(
                `ğŸ˜¢ åœ°ä¸»è·èƒœï¼Œä½ è¾“äº† ${ethers.formatEther(singleAmount)} SOL`
              );
            }
          } else {
            // å†œæ°‘èµ¢ï¼šæ¯ä¸ªå†œæ°‘è·å¾— singleAmount
            if (winnerIndex === this.mySeatIndex) {
              this.showToast(
                `ğŸ‰ å†œæ°‘èƒœåˆ©ï¼èµ¢å¾— ${ethers.formatEther(singleAmount)} SOL`
              );
            } else if (this.mySeatIndex === landlordIndex) {
              const loseAmount = singleAmount * 2n;
              this.showToast(
                `ğŸ˜¢ å†œæ°‘è·èƒœï¼Œä½ è¾“äº† ${ethers.formatEther(loseAmount)} SOL`
              );
            } else {
              this.showToast(
                `ğŸ‰ é˜Ÿå‹è·èƒœï¼èµ¢å¾— ${ethers.formatEther(singleAmount)} SOL`
              );
            }
          }

          // ç­‰å¾…2ç§’å±•ç¤ºç»“æœ
          await new Promise((r) => setTimeout(r, 2000));

          // å°†ä¸´æ—¶é’±åŒ…ä½™é¢å…¨éƒ¨è½¬å›ä¸»é’±åŒ…
          await this.returnBurnerFunds();
        }

        // å°†ä¸´æ—¶é’±åŒ…ä½™é¢è½¬å›ä¸»é’±åŒ…
        async returnBurnerFunds() {
          try {
            const balance = await this.provider.getBalance(
              this.burnerSigner.address
            );

            if (balance === 0n) {
              this.showToast("ä¸´æ—¶é’±åŒ…å·²æ¸…ç©º");
              this.resetGame();
              return;
            }

            // é¢„ä¼°gasè´¹ç”¨
            const gasPrice = (await this.provider.getFeeData()).gasPrice;
            const gasLimit = 21000n;
            const gasCost = gasPrice * gasLimit;

            if (balance <= gasCost) {
              this.showToast("ä½™é¢ä¸è¶³æ”¯ä»˜gasè´¹");
              this.resetGame();
              return;
            }

            const transferAmount = balance - gasCost;

            this.showToast(
              `æ­£åœ¨è½¬å› ${ethers.formatEther(transferAmount)} SOL...`
            );

            const tx = await this.burnerSigner.sendTransaction({
              to: this.mainAddress,
              value: transferAmount,
              gasLimit: gasLimit,
              gasPrice: gasPrice,
            });

            await tx.wait();

            this.showToast("âœ… èµ„é‡‘å·²è½¬å›ä¸»é’±åŒ…ï¼");
            await this.updateBalanceDisplay();

            this.resetGame();
          } catch (e) {
            console.error("è½¬è´¦å¤±è´¥:", e);
            this.showToast("è½¬è´¦å¤±è´¥: " + e.message);
            this.resetGame();
          }
        }

        // é‡ç½®æ¸¸æˆçŠ¶æ€
        resetGame() {
          this.tableId = 0;
          this.handCards = [];
          this.selectedCards.clear();
          this.baseMultiplier = 1;
          this.bombMultiplier = 1;
          this.isGameEnded = false;
          this.renderHand();
          this.showControls("join");
          document.getElementById("btn-join").innerText =
            "åŠ å…¥æ¸¸æˆ (å……å€¼ 0.01 SOL)";
          document.getElementById("btn-join").disabled = false;
        }
        showToast(msg) {
          const div = document.createElement("div");
          div.style.cssText =
            "position:fixed; top:20px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.8); padding:10px 20px; border-radius:5px; z-index:999;";
          div.innerText = msg;
          document.body.appendChild(div);
          setTimeout(() => div.remove(), 3000);
        }
      }

      const game = new DoudizhuGame();
      document.getElementById("btn-connect").onclick = () => game.init();
      document.getElementById("btn-join").onclick = () => game.join();
    </script>
  </body>
</html>
